<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .main-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .main-btn.secondary {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            text-align: right;
            -webkit-text-align: right;
            -webkit-direction: rtl;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn.success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .btn.danger {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        .btn.back {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .preview-container {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-container.active {
            display: block;
        }

        .medical-form {
            max-width: 21cm;
            margin: 0 auto;
            background: white;
            padding: 40px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            border: 1px solid #ddd;
        }

        .doctor-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }

        .doctor-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .doctor-title {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .doctor-license {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .clinic-info {
            font-size: 12px;
            color: #666;
        }

        .visit-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            margin-bottom: 30px;
            gap: 20px;
        }

        .visit-date {
            text-align: left;
            font-weight: bold;
        }

        .patient-info {
            text-align: right;
        }

        .patient-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .patient-id {
            font-size: 14px;
            color: #666;
        }

        .summary-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0;
        }

        .visit-details {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        .medical-content {
            margin-bottom: 30px;
        }

        .content-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .diagnosis-line {
            border-top: 2px solid #333;
            margin: 30px 0;
        }

        .instructions-title {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: right;
        }

        .signature-section {
            position: relative;
            height: 3cm;
            margin-top: 40px;
        }

        .signature-text {
            position: static !important;
            visibility: visible !important;
            font-weight: bold;
            text-align: right;
            margin-bottom: 15px;
        }

        .signature-stamp {
            position: absolute !important;
            bottom: 0;
            left: 0;
            margin-right: auto;
            margin-left: 0;
            width: 4cm;
            padding: 10px;
            font-size: 11px;
            line-height: 1.3;
            text-align: center;
            border: 1px solid #333;
            background: white;
            visibility: visible !important;
            box-sizing: border-box;
        }

        /* היסטוריה */
        .search-container {
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .search-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            direction: rtl;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .history-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .history-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        /* תיקונים מיוחדים להדפסה */
@media print {
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        height: auto !important;
        overflow: visible !important;
        font-size: 14px !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    * {
        visibility: hidden !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
    }
    
    .medical-form, .medical-form * {
        visibility: visible !important;
    }
    
    .medical-form {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        height: auto !important;
        max-width: none !important;
        max-height: none !important;
        padding: 1.2cm 1.8cm 0.8cm 1.8cm !important;
        margin: 0 !important;
        font-size: 13px !important;
        line-height: 1.4 !important;
        background: white !important;
        border: none !important;
        direction: rtl !important;
        text-align: right !important;
        overflow: visible !important;
        box-sizing: border-box !important;
        page-break-after: auto !important;
        page-break-inside: auto !important;
    }
    
    .doctor-header {
        text-align: center !important;
        margin-bottom: 15px !important;
        border-bottom: 1px solid #333 !important;
        padding-bottom: 10px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .visit-info {
        display: flex !important;
        justify-content: space-between !important;
        margin-bottom: 15px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .visit-date {
        text-align: left !important;
    }
    
    .patient-info {
        text-align: right !important;
    }
    
    .summary-title {
        text-align: center !important;
        margin: 10px 0 !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .visit-details {
        text-align: center !important;
        margin-bottom: 10px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .content-section {
        margin-bottom: 10px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }
    
    .section-title {
        text-align: right !important;
        font-weight: bold !important;
        margin-bottom: 5px !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .instructions-title {
        text-align: right !important;
        font-weight: bold !important;
        margin-bottom: 8px !important;
        page-break-after: avoid !important;
        break-after: avoid !important;
    }
    
    .medical-content {
        margin-bottom: 10px !important;
        text-align: right !important;
        page-break-inside: auto !important;
        break-inside: auto !important;
    }
    
    .diagnosis-line {
        margin: 10px 0 !important;
        border-top: 1px solid #333 !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }
    
    .signature-section {
        margin-top: 15px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
        min-height: auto !important;
        height: auto !important;
        overflow: visible !important;
    }

    .signature-text {
        font-weight: bold !important;
        text-align: right !important;
        margin-bottom: 0px !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
    }
    .page-two-spacer {
    height: 3cm !important;
    page-break-before: always !important;
    visibility: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
}
.page-break-spacer {
    page-break-before: always !important;
    height: 3cm !important;
    visibility: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    display: block !important;
}
@page {
    size: A4 !important;
    margin: 0 !important;
    padding: 0 !important;
}

@page:first {
    margin: 0 !important;
}


/* אילוץ עמוד יחיד */
html {
    max-height: 29.7cm !important;
    overflow: hidden !important;
}

body {
    max-height: 29.7cm !important;
    overflow: hidden !important;
    page-break-after: avoid !important;
}
    
    .medical-form, .medical-form *, 
    .doctor-header, .visit-info, .summary-title, 
    .visit-details, .medical-content, .signature-section {
        page-break-after: avoid !important;
        break-after: avoid !important;
        page-break-before: avoid !important;
        break-before: avoid !important;
    }
    
    .medical-form > *:not(:last-child) {
        margin-bottom: 8px !important;
    }
    
    .medical-form > *:last-child {
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
    }
    
    .medical-form.compact {
        font-size: 11px !important;
        line-height: 1.3 !important;
    }
    
    .medical-form.compact .doctor-header {
        margin-bottom: 10px !important;
        padding-bottom: 8px !important;
    }
    
    .medical-form.compact .visit-info,
    .medical-form.compact .summary-title,
    .medical-form.compact .visit-details,
    .medical-form.compact .content-section,
    .medical-form.compact .medical-content,
    .medical-form.compact .diagnosis-line {
        margin-bottom: 6px !important;
    }
    
    .medical-form.compact .signature-section {
        margin-top: 10px !important;
    }
}

        @media screen and (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .main-buttons {
                grid-template-columns: 1fr;
            }
            .form-group textarea {
    text-align: right !important;
    direction: rtl !important;
    -webkit-direction: rtl !important;
    unicode-bidi: plaintext;
}
            
            .visit-info,
            .signature-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .medical-form {
                padding: 20px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 מערכת סיכומי ייעוץ רפואי</h1>
            <p>ד"ר אריאל כץ - מומחה ומנתח אא"ג</p>
        </div>

        <div class="main-content">
            <!-- דף ראשי -->
            <div id="mainSection" class="section active">
                <div class="main-buttons">
                    <button class="main-btn" onclick="showNewConsultation()">
                        📝 הזנת סיכום ייעוץ חדש
                    </button>
                    <button class="main-btn secondary" onclick="showHistory()">
                        📋 היסטוריית סיכומים
                    </button>
                </div>
            </div>

            <!-- הזנת סיכום חדש -->
            <div id="newConsultationSection" class="section">
                <button class="btn back" onclick="showMain()">← חזרה לדף הראשי</button>
                
                <div class="form-container">
                    <h2>סיכום ייעוץ רפואי חדש</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName">שם המטופל</label>
                            <input type="text" id="patientName" placeholder="הזן שם מלא">
                        </div>
                        <div class="form-group">
                            <label for="patientId">תעודת זהות</label>
                            <input type="text" id="patientId" placeholder="הזן מספר תעודת זהות">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="medicalReview">סקירה רפואית</label>
                        <textarea id="medicalReview" placeholder="הזן סקירה רפואית מפורטת..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="diagnosis">אבחנות</label>
                        <textarea id="diagnosis" placeholder="הזן אבחנות..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="instructions">הנחיות</label>
                        <textarea id="instructions" placeholder="הזן הנחיות טיפול..."></textarea>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn" onclick="generatePreview()">צור תצוגה מקדימה</button>
                        <button class="btn danger" onclick="clearForm()">נקה טופס</button>
                    </div>
                </div>

                <!-- תצוגה מקדימה -->
                <div id="previewContainer" class="preview-container">
                    <div class="medical-form" id="medicalForm">
                        <!-- התוכן ייווצר דינמית -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn success" onclick="saveAndPrint()">💾 העלה לענן והדפס</button>
                        <button id="clearAfterPrintBtn" class="btn danger hidden" onclick="clearForm()">🧹 נקה טופס</button>
                    </div>
                </div>
            </div>

            <!-- היסטוריית סיכומים -->
            <div id="historySection" class="section">
                <button class="btn back" onclick="showMain()">← חזרה לדף הראשי</button>
                
                <h2>היסטוריית סיכומים</h2>
                
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="חפש לפי שם מטופל או תעודת זהות...">
                    <button class="btn" onclick="searchSummaries()">🔍 חפש</button>
                </div>

                <div class="stats hidden" id="statsSection">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSummaries">0</div>
                        <div class="stat-label">סיכומים</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisMonth">0</div>
                        <div class="stat-label">החודש</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="latestDate">-</div>
                        <div class="stat-label">עדכון אחרון</div>
                    </div>
                </div>

                <div id="loadingHistory" class="loading hidden">
                    <div class="spinner"></div>
                    <div>טוען היסטוריה...</div>
                </div>

                <table id="historyTable" class="history-table hidden">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>שם המטופל</th>
                            <th>תעודת זהות</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>

                <div class="empty-state hidden" id="emptyState">
                    <h3>📭 אין סיכומים להצגה</h3>
                    <p>עדיין לא נשמרו סיכומים במערכת</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getStorage, ref, uploadString, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCe24QH6BXEWtF2zJWcP8WhV8qKj-3l-00",
        authDomain: "gaash-2ea82.firebaseapp.com",
        projectId: "gaash-2ea82",
        storageBucket: "gaash-2ea82.firebasestorage.app",
        messagingSenderId: "1054252503536",
        appId: "1:1054252503536:web:4b7c546bd737de696e4d35"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // Global variables
    let allSummaries = [];
    let currentSummaries = [];

    // Navigation functions
    window.showMain = function() {
        hideAllSections();
        document.getElementById('mainSection').classList.add('active');
    };

    window.showNewConsultation = function() {
        hideAllSections();
        document.getElementById('newConsultationSection').classList.add('active');
    };

    window.showHistory = function() {
        hideAllSections();
        document.getElementById('historySection').classList.add('active');
        loadHistory();
    };

    function hideAllSections() {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
    }

    // Form functions
    window.generatePreview = function() {
        const patientName = document.getElementById('patientName').value;
        const patientId = document.getElementById('patientId').value;
        const medicalReview = document.getElementById('medicalReview').value;
        const diagnosis = document.getElementById('diagnosis').value;
        const instructions = document.getElementById('instructions').value;

        if (!patientName || !patientId) {
            alert('יש למלא לפחות שם מטופל ותעודת זהות');
            return;
        }

        const today = new Date().toLocaleDateString('he-IL');
        
        const formHtml = `
            <div class="doctor-header">
                <div class="doctor-name">ד"ר אריאל כץ</div>
                <div class="doctor-title">מומחה ומנתח אא"ג</div>
                <div class="doctor-license">מ.ר. 38091 מ.ר.מ 30570</div>
                <div class="clinic-info">מרפאת מרום, אמנון ותמר 6 נתניה, טלפון - 074-705-0889</div>
            </div>

            <div class="visit-info">
                <div class="patient-info">
                    <div class="patient-name">${patientName}</div>
                    <div class="patient-id">ת"ז ${patientId}</div>
                </div>
                <div class="visit-date">${today}</div>
            </div>

            <div class="summary-title">סיכום ייעוץ רפואי</div>

            <div class="visit-details">
                ביקור שנערך בנתניה בתאריך ${today}
            </div>

            <div class="medical-content">
                ${medicalReview ? `<div class="content-section">
                    <div class="section-title">סקירה:</div>
                    <div>${medicalReview.replace(/\n/g, '<br>')}</div>
                </div>` : ''}

                ${diagnosis ? `<div class="content-section">
                    <div class="section-title">אבחנות:</div>
                    <div>${diagnosis.replace(/\n/g, '<br>')}</div>
                </div>` : ''}
            </div>

            <div class="diagnosis-line"></div>

            <div class="instructions-title">הנחיות:</div>
            <div class="medical-content">
                ${instructions ? instructions.replace(/\n/g, '<br>') : ''}
            </div>

<div class="signature-section">
    <div class="signature-text">
        בברכה,<br>ד"ר אריאל כץ
    </div>
</div>

<div class="page-break-spacer" style="page-break-before: always; height: 3cm; visibility: hidden; margin: 0; padding: 0;"></div>
        `;

        document.getElementById('medicalForm').innerHTML = formHtml;
        document.getElementById('previewContainer').classList.add('active');
        
        // גלילה לתצוגה המקדימה
        document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
    };

    window.clearForm = function() {
        document.getElementById('patientName').value = '';
        document.getElementById('patientId').value = '';
        document.getElementById('medicalReview').value = '';
        document.getElementById('diagnosis').value = '';
        document.getElementById('instructions').value = '';
        document.getElementById('previewContainer').classList.remove('active');
        document.getElementById('clearAfterPrintBtn').classList.add('hidden');
    };

    // פונקציה מיוחדת להכנת הדפסה - מניעת עמוד שני
function optimizeForPrint() {
    const form = document.getElementById('medicalForm');
    if (!form) return;

    // איפוס סגנונות קודמים
    form.style.fontSize = '';
    form.style.lineHeight = '';
    form.style.padding = '';

    // הגדרות בסיסיות להדפסה
    form.style.maxHeight = 'none';
    form.style.overflow = 'visible';

    // הסרת כל הרווחים הגדולים
    const allElements = form.querySelectorAll('*');
    allElements.forEach(el => {
        el.style.marginBottom = '10px';
        el.style.paddingBottom = '0px';
    });

    // הקטנת רווחים ספציפיים
    const doctorHeader = form.querySelector('.doctor-header');
    if (doctorHeader) {
        doctorHeader.style.marginBottom = '15px';
        doctorHeader.style.paddingBottom = '10px';
    }

    const visitInfo = form.querySelector('.visit-info');
    if (visitInfo) {
        visitInfo.style.marginBottom = '15px';
    }

    const summaryTitle = form.querySelector('.summary-title');
    if (summaryTitle) {
        summaryTitle.style.margin = '10px 0';
    }

    const visitDetails = form.querySelector('.visit-details');
    if (visitDetails) {
        visitDetails.style.marginBottom = '10px';
    }

    const contentSections = form.querySelectorAll('.content-section');
    contentSections.forEach(section => {
        section.style.marginBottom = '10px';
    });

    const diagnosisLine = form.querySelector('.diagnosis-line');
    if (diagnosisLine) {
        diagnosisLine.style.margin = '10px 0';
    }

    const instructionsTitle = form.querySelector('.instructions-title');
    if (instructionsTitle) {
        instructionsTitle.style.marginBottom = '8px';
    }

    const medicalContent = form.querySelectorAll('.medical-content');
    medicalContent.forEach(content => {
        content.style.marginBottom = '10px';
    });

    const signatureSection = form.querySelector('.signature-section');
    if (signatureSection) {
        signatureSection.style.marginTop = '15px';
        signatureSection.style.minHeight = 'auto';
        signatureSection.style.height = 'auto';
    }

    const signatureText = form.querySelector('.signature-text');
    if (signatureText) {
        signatureText.style.marginBottom = '0px';
    }

    // בדיקה של גובה בפיקסלים
    setTimeout(() => {
        const formHeight = form.offsetHeight;
        console.log('Form height:', formHeight);
        
        // אם הגובה גדול מ-950px, הקטן את הפונט
        if (formHeight > 950) {
            form.style.fontSize = '12px';
            form.style.lineHeight = '1.3';
            form.style.padding = '1cm 1.5cm 1cm 1.5cm';
            
            // בדיקה נוספת
            setTimeout(() => {
                const newHeight = form.offsetHeight;
                console.log('New form height:', newHeight);
                
                if (newHeight > 950) {
                    form.style.fontSize = '11px';
                    form.style.lineHeight = '1.2';
                    
                    // הקטנת רווחים נוספת
                    allElements.forEach(el => {
                        el.style.marginBottom = '5px';
                    });
                }
            }, 100);
        }
    }, 100);
    // הוספת רווח לעמוד שני אם יש כזה

}
    // שמירה רק לענן
    window.saveAndPrint = async function() {
        const patientName = document.getElementById('patientName').value;
        const patientId = document.getElementById('patientId').value;
        const medicalReview = document.getElementById('medicalReview').value;
        const diagnosis = document.getElementById('diagnosis').value;
        const instructions = document.getElementById('instructions').value;

        if (!patientName || !patientId) {
            alert('יש למלא לפחות שם מטופל ותעודת זהות');
            return;
        }

        try {
            // יצירת שם קובץ עם תאריך ושעה
            const now = new Date();
            const dateStr = now.toLocaleDateString('he-IL').replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
            const fileName = `${patientName}_${patientId}_${dateStr}_${timeStr}.json`;

            // יצירת נתונים לשמירה
            const summaryData = {
                patientName: patientName,
                patientId: patientId,
                medicalReview: medicalReview,
                diagnosis: diagnosis,
                instructions: instructions,
                date: now.toISOString(),
                dateString: now.toLocaleDateString('he-IL'),
                timeString: now.toLocaleTimeString('he-IL')
            };

            // שמירה בענן בלבד
            const storageRef = ref(storage, `ariel/${fileName}`);
            await uploadString(storageRef, JSON.stringify(summaryData), 'raw');

            alert('הסיכום נשמר בענן בהצלחה! ✅');
            
        } catch (error) {
            console.error('שגיאה בשמירה:', error);
            alert('⚠️ שגיאה בשמירה לענן. נסה שוב.');
            return;
        }
        
        // אופטימיזציה להדפסה
// אופטימיזציה להדפסה
optimizeForPrint();

// הדפסה
const originalTitle = document.title;
const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');
document.title = `סיכום_${patientName}_${dateStr}`;

// הוספת עיכוב ארוך יותר כדי לוודא שהאופטימיזציה החלה
setTimeout(() => {
    // בדיקה אחרונה של גובה ואילוץ הקטנה אם צריך
    const form = document.getElementById('medicalForm');
    const formHeight = form.offsetHeight;
    console.log('Final check - form height before print:', formHeight);
    
    if (formHeight > 1000) {
        form.classList.add('compact');
        form.style.fontSize = '11px';
        form.style.lineHeight = '1.2';
        form.style.padding = '1cm 1.5cm 0.5cm 1.5cm';
        console.log('Applied compact mode');
    }
    
    setTimeout(() => {
        window.print();
        
        setTimeout(() => {
            document.title = originalTitle;
            form.classList.remove('compact');
            document.getElementById('clearAfterPrintBtn').classList.remove('hidden');
        }, 1000);
    }, 300);
}, 500);
    };

    // טעינה רק מהענן
    async function loadHistory() {
        try {
            document.getElementById('loadingHistory').classList.remove('hidden');
            document.getElementById('historyTable').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            allSummaries = [];

            // טעינה מהענן דרך CORS Proxy
            try {
                const listRef = ref(storage, 'ariel/');
                const result = await listAll(listRef);
                
                for (const itemRef of result.items) {
                    try {
                        // קבלת URL ישיר
                        const url = await getDownloadURL(itemRef);
                        
                        // שימוש ב-corsproxy.io
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl);
                        const text = await response.text();
                        const data = JSON.parse(text);
                        
                        data.id = itemRef.name;
                        data.isCloud = true;
                        allSummaries.push(data);
                    } catch (fileError) {
                        console.log(`לא ניתן לטעון קובץ ${itemRef.name}, ממשיך...`);
                    }
                }
                
                if (allSummaries.length > 0) {
                    console.log(`נטענו ${allSummaries.length} סיכומים מהענן`);
                }
            } catch (cloudError) {
                console.error('שגיאה בטעינה מהענן:', cloudError);
                document.getElementById('loadingHistory').innerHTML = 
                    '<div style="color: #e74c3c;">❌ שגיאה בחיבור לענן</div>';
                return;
            }

            // מיון לפי תאריך
            allSummaries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            currentSummaries = allSummaries;
            displayHistory();
            updateStats();

            document.getElementById('loadingHistory').classList.add('hidden');
            
            if (allSummaries.length > 0) {
                document.getElementById('historyTable').classList.remove('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.remove('hidden');
            }

        } catch (error) {
            console.error('שגיאה בטעינת ההיסטוריה:', error);
            document.getElementById('loadingHistory').innerHTML = 
                '<div style="color: #e74c3c;">❌ שגיאה בטעינת ההיסטוריה</div>';
        }
    }

    function displayHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';

        currentSummaries.forEach((summary) => {
            const row = document.createElement('tr');
            const date = new Date(summary.date).toLocaleDateString('he-IL');
            const time = summary.timeString || new Date(summary.date).toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
            
            row.innerHTML = `
                <td>${date} ${time} ☁️</td>
                <td>${summary.patientName || 'לא זמין'}</td>
                <td>${summary.patientId || 'לא זמין'}</td>
                <td class="actions">
                    <button class="btn" onclick="viewSummary('${summary.id}')">👁️ צפייה</button>
                    <button class="btn success" onclick="printSummary('${summary.id}')">🖨️ הדפסה</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        if (currentSummaries.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="4" style="text-align: center; padding: 30px; color: #666;">אין סיכומים להצגה</td>';
            tbody.appendChild(row);
        }
    }

    function updateStats() {
        const total = allSummaries.length;
        const thisMonth = allSummaries.filter(s => {
            const summaryDate = new Date(s.date);
            const now = new Date();
            return summaryDate.getMonth() === now.getMonth() && 
                   summaryDate.getFullYear() === now.getFullYear();
        }).length;
        
        const latest = allSummaries.length > 0 ? 
            new Date(allSummaries[0].date).toLocaleDateString('he-IL') : '-';

        document.getElementById('totalSummaries').textContent = total;
        document.getElementById('thisMonth').textContent = thisMonth;
        document.getElementById('latestDate').textContent = latest;
    }

    window.searchSummaries = function() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        
        if (!searchTerm) {
            currentSummaries = allSummaries;
        } else {
            currentSummaries = allSummaries.filter(summary => 
                (summary.patientName && summary.patientName.toLowerCase().includes(searchTerm)) ||
                (summary.patientId && summary.patientId.includes(searchTerm))
            );
        }
        
        displayHistory();
        
        if (currentSummaries.length > 0) {
            document.getElementById('historyTable').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        } else {
            document.getElementById('historyTable').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.querySelector('.empty-state h3').textContent = '🔍 לא נמצאו תוצאות';
            document.querySelector('.empty-state p').textContent = 'נסה לחפש במילות מפתח אחרות';
        }
    };

    window.viewSummary = function(summaryId) {
        const summary = allSummaries.find(s => s.id === summaryId);
        if (!summary) {
            alert('סיכום לא נמצא');
            return;
        }

        // מילוי הטופס עם הנתונים הקיימים
        document.getElementById('patientName').value = summary.patientName || '';
        document.getElementById('patientId').value = summary.patientId || '';
        document.getElementById('medicalReview').value = summary.medicalReview || '';
        document.getElementById('diagnosis').value = summary.diagnosis || '';
        document.getElementById('instructions').value = summary.instructions || '';

        // עבור לעמוד החדש וצור תצוגה מקדימה
        showNewConsultation();
        setTimeout(() => {
            generatePreview();
            // גלילה לתצוגה המקדימה
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    };

    window.printSummary = function(summaryId) {
        const summary = allSummaries.find(s => s.id === summaryId);
        if (!summary) {
            alert('סיכום לא נמצא');
            return;
        }

        // מילוי הטופס זמנית
        const originalValues = {
            name: document.getElementById('patientName').value,
            id: document.getElementById('patientId').value,
            review: document.getElementById('medicalReview').value,
            diagnosis: document.getElementById('diagnosis').value,
            instructions: document.getElementById('instructions').value
        };

        document.getElementById('patientName').value = summary.patientName || '';
        document.getElementById('patientId').value = summary.patientId || '';
        document.getElementById('medicalReview').value = summary.medicalReview || '';
        document.getElementById('diagnosis').value = summary.diagnosis || '';
        document.getElementById('instructions').value = summary.instructions || '';

        // יצירת תצוגה זמנית להדפסה
        generatePreview();
        
        setTimeout(() => {
            // אופטימיזציה להדפסה
            optimizeForPrint();
            
            const originalTitle = document.title;
            document.title = `סיכום_${summary.patientName}_${new Date(summary.date).toLocaleDateString('he-IL').replace(/\//g, '-')}`;
            
            setTimeout(() => {
                window.print();
                document.title = originalTitle;
                
                // החזרת הערכים המקוריים
                document.getElementById('patientName').value = originalValues.name;
                document.getElementById('patientId').value = originalValues.id;
                document.getElementById('medicalReview').value = originalValues.review;
                document.getElementById('diagnosis').value = originalValues.diagnosis;
                document.getElementById('instructions').value = originalValues.instructions;
                
                if (originalValues.name || originalValues.id) {
                    generatePreview();
                } else {
                    document.getElementById('previewContainer').classList.remove('active');
                    document.getElementById('clearAfterPrintBtn').classList.add('hidden');
                }
            }, 200);
        }, 500);
    };

    // Event listeners
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchSummaries();
        }
    });

    // טעינה אוטומטית של הרשימה כשהעמוד נטען
    window.addEventListener('load', function() {
        console.log('מערכת סיכומי ייעוץ רפואי מוכנה לשימוש');
    });

    // הוסף את זה לקוד שלך
    document.addEventListener('DOMContentLoaded', function() {
        const textareas = document.querySelectorAll('textarea');
        // תיקון לאייפון
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
if (isIOS) {
    textareas.forEach(textarea => {
        textarea.addEventListener('focus', function() {
            this.style.textAlign = 'right';
            this.style.direction = 'rtl';
        });
    });
}
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                let text = this.value;
                let lines = text.split('\n');
                let newLines = [];
                
                lines.forEach(line => {
                    while (line.length > 93) {
                        // מוצא את המקום הטוב ביותר לשבור (רווח אחרון לפני 93)
                        let breakPoint = 93;
                        let lastSpace = line.lastIndexOf(' ', 93);
                        
                        if (lastSpace > 70) { // אם יש רווח לא רחוק מדי
                            breakPoint = lastSpace;
                        }
                        
                        newLines.push(line.substring(0, breakPoint));
                        line = line.substring(breakPoint).trim();
                    }
                    newLines.push(line);
                });
                
                this.value = newLines.join('\n');
            });
        });
    });
</script>
