<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×¡×™×›×•××™ ×™×™×¢×•×¥ ×¨×¤×•××™</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        /* ××¡×š ×›× ×™×¡×” */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .auth-container {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-title {
            font-size: 2em;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .auth-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

.pin-input {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 30px 0;
    direction: ltr; /* ×”×•×¡×£ ××ª ×–×” */
}

        .pin-digit {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .pin-digit:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pin-digit.filled {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .pin-digit.error {
            border-color: #e74c3c;
            background: #ffe6e6;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .error-message.show {
            opacity: 1;
        }

        .lock-icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .timer-display {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            color: #333;
            z-index: 1000;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .timer-display.warning {
            background: rgba(255,193,7,0.9);
            color: #856404;
        }

        .timer-display.danger {
            background: rgba(220,53,69,0.9);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ×©××¨ ×”×¡×˜×™×™×œ×™× ×”×§×™×™××™× */
        .form-group textarea:not(#diagnosis) {
            text-align: right !important;
            direction: rtl !important;
            -webkit-text-align: right !important;
            -webkit-direction: rtl !important;
            unicode-bidi: plaintext !important;
        }

        .form-group textarea:not(#diagnosis):focus {
            text-align: right !important;
            direction: rtl !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            padding: 30px;
        }

        .main-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .main-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .main-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .main-btn.secondary {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .diagnosis-content {
            direction: ltr !important;
            text-align: left !important;
            font-weight: bold !important;
        }

        .form-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Heebo', sans-serif;
            direction: rtl;
            text-align: right;
            -webkit-text-align: right;
            -webkit-direction: rtl;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        #diagnosis {
            direction: ltr !important;
            text-align: left !important;
            font-weight: bold !important;
            -webkit-direction: ltr !important;
            -webkit-text-align: left !important;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn.success {
            background: linear-gradient(135deg, #00b894, #00a085);
        }

        .btn.danger {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        .btn.back {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .preview-container {
            display: none;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-container.active {
            display: block;
        }

        .medical-form {
            max-width: 21cm;
            margin: 0 auto;
            background: white;
            padding: 40px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            border: 1px solid #ddd;
        }

        .doctor-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }

        .doctor-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .doctor-title {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .doctor-license {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .clinic-info {
            font-size: 12px;
            color: #666;
        }

        .visit-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            margin-bottom: 30px;
            gap: 20px;
        }

        .visit-date {
            text-align: left;
            font-weight: bold;
        }

        .patient-info {
            text-align: right;
        }

        .patient-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .patient-id {
            font-size: 14px;
            color: #666;
        }

        .summary-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 30px 0;
        }

        .visit-details {
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }

        .medical-content {
            margin-bottom: 30px;
        }

        .content-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .diagnosis-line {
            border-top: 2px solid #333;
            margin: 30px 0;
        }

        .instructions-title {
            font-weight: bold;
            margin-bottom: 15px;
            text-align: right;
        }

        .signature-section {
            position: relative;
            height: 3cm;
            margin-top: 40px;
        }

        .signature-text {
            position: static !important;
            visibility: visible !important;
            font-weight: bold;
            text-align: right;
            margin-bottom: 15px;
        }

        .signature-stamp {
            position: absolute !important;
            bottom: 0;
            left: 0;
            margin-right: auto;
            margin-left: 0;
            width: 4cm;
            padding: 10px;
            font-size: 11px;
            line-height: 1.3;
            text-align: center;
            border: 1px solid #333;
            background: white;
            visibility: visible !important;
            box-sizing: border-box;
        }

        .search-container {
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .search-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            direction: rtl;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .history-table thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .history-table .actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        /* ×ª×™×§×•× ×™× ××™×•×—×“×™× ×œ×”×“×¤×¡×” */
        @media print {
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                height: auto !important;
                overflow: visible !important;
                font-size: 14px !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            .medical-form .content-section:nth-of-type(2) div:last-child,
            .medical-form div[style*="diagnosis"] {
                direction: ltr !important;
                text-align: left !important;
                font-weight: bold !important;
                -webkit-direction: ltr !important;
                -webkit-text-align: left !important;
            }
            * {
                visibility: hidden !important;
                -webkit-box-sizing: border-box !important;
                box-sizing: border-box !important;
            }
            
            .medical-form, .medical-form * {
                visibility: visible !important;
            }
            .diagnosis-content {
                direction: ltr !important;
                text-align: left !important;
                font-weight: bold !important;
                -webkit-direction: ltr !important;
                -webkit-text-align: left !important;
            }
            .medical-form {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: auto !important;
                max-width: none !important;
                max-height: none !important;
                padding: 1.2cm 1.8cm 0.8cm 1.8cm !important;
                margin: 0 !important;
                font-size: 13px !important;
                line-height: 1.4 !important;
                background: white !important;
                border: none !important;
                direction: rtl !important;
                text-align: right !important;
                overflow: visible !important;
                box-sizing: border-box !important;
                page-break-after: auto !important;
                page-break-inside: auto !important;
            }
            
            .doctor-header {
                text-align: center !important;
                margin-bottom: 15px !important;
                border-bottom: 1px solid #333 !important;
                padding-bottom: 10px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .visit-info {
                display: flex !important;
                justify-content: space-between !important;
                margin-bottom: 15px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .visit-date {
                text-align: left !important;
            }
            
            .patient-info {
                text-align: right !important;
            }
            
            .summary-title {
                text-align: center !important;
                margin: 10px 0 !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .visit-details {
                text-align: center !important;
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .content-section {
                margin-bottom: 10px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .section-title {
                text-align: right !important;
                font-weight: bold !important;
                margin-bottom: 5px !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .instructions-title {
                text-align: right !important;
                font-weight: bold !important;
                margin-bottom: 8px !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            }
            
            .medical-content {
                margin-bottom: 10px !important;
                text-align: right !important;
                page-break-inside: auto !important;
                break-inside: auto !important;
            }
            
            .diagnosis-line {
                margin: 10px 0 !important;
                border-top: 1px solid #333 !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            .signature-section {
                margin-top: 15px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                min-height: auto !important;
                height: auto !important;
                overflow: visible !important;
            }

            .signature-text {
                font-weight: bold !important;
                text-align: right !important;
                margin-bottom: 0px !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            .page-two-spacer {
                height: 3cm !important;
                page-break-before: always !important;
                visibility: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .page-break-spacer {
                page-break-before: always !important;
                height: 3cm !important;
                visibility: hidden !important;
                margin: 0 !important;
                padding: 0 !important;
                display: block !important;
            }
            @page {
                size: A4 !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            @page:first {
                margin: 0 !important;
            }

            html {
                max-height: 29.7cm !important;
                overflow: hidden !important;
            }

            body {
                max-height: 29.7cm !important;
                overflow: hidden !important;
                page-break-after: avoid !important;
            }
            
            .medical-form, .medical-form *, 
            .doctor-header, .visit-info, .summary-title, 
            .visit-details, .medical-content, .signature-section {
                page-break-after: avoid !important;
                break-after: avoid !important;
                page-break-before: avoid !important;
                break-before: avoid !important;
            }
            
            .medical-form > *:not(:last-child) {
                margin-bottom: 8px !important;
            }
            
            .medical-form > *:last-child {
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
            
            .medical-form.compact {
                font-size: 11px !important;
                line-height: 1.3 !important;
            }
            
            .medical-form.compact .doctor-header {
                margin-bottom: 10px !important;
                padding-bottom: 8px !important;
            }
            
            .medical-form.compact .visit-info,
            .medical-form.compact .summary-title,
            .medical-form.compact .visit-details,
            .medical-form.compact .content-section,
            .medical-form.compact .medical-content,
            .medical-form.compact .diagnosis-line {
                margin-bottom: 6px !important;
            }
            
            .medical-form.compact .signature-section {
                margin-top: 10px !important;
            }

            /* ×”×¡×ª×¨ ××œ×× ×˜×™ ×”×–×“×”×•×ª ×‘×”×“×¤×¡×” */
            .auth-overlay, .timer-display {
                display: none !important;
            }
        }

        @media screen and (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .main-buttons {
                grid-template-columns: 1fr;
            }
            .form-group textarea {
                text-align: right !important;
                direction: rtl !important;
                -webkit-direction: rtl !important;
                unicode-bidi: plaintext;
            }
            
            .visit-info,
            .signature-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .medical-form {
                padding: 20px;
                font-size: 12px;
            }

            .auth-container {
                padding: 30px;
            }

            .pin-digit {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ××¡×š ×”×–×“×”×•×ª -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-container">
            <div class="lock-icon">ğŸ”’</div>
            <div class="auth-title">××¢×¨×›×ª ×××•×‘×˜×—×ª</div>
            <div class="auth-subtitle">× × ×œ×”×–×™×Ÿ ×§×•×“ ×›× ×™×¡×” ×‘×Ÿ 4 ×¡×¤×¨×•×ª</div>
            
<div class="pin-input">
    <input type="password" 
           maxlength="1" 
           class="pin-digit" 
           id="pin1"
           inputmode="numeric" 
           pattern="[0-9]*">
    <input type="password" 
           maxlength="1" 
           class="pin-digit" 
           id="pin2"
           inputmode="numeric" 
           pattern="[0-9]*">
    <input type="password" 
           maxlength="1" 
           class="pin-digit" 
           id="pin3"
           inputmode="numeric" 
           pattern="[0-9]*">
    <input type="password" 
           maxlength="1" 
           class="pin-digit" 
           id="pin4"
           inputmode="numeric" 
           pattern="[0-9]*">
</div>
            
            <button class="auth-button" id="loginBtn" onclick="attemptLogin()">
                ğŸ”“ ×›× ×™×¡×” ×œ××¢×¨×›×ª
            </button>
            
            <div class="error-message" id="errorMessage">
                ×§×•×“ ×©×’×•×™, × ×¡×” ×©×•×‘
            </div>
        </div>
    </div>

    <!-- ××—×•×•×Ÿ ×–××Ÿ -->
    <div id="timerDisplay" class="timer-display hidden">
        â±ï¸ <span id="timeLeft">30:00</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¥ ××¢×¨×›×ª ×¡×™×›×•××™ ×™×™×¢×•×¥ ×¨×¤×•××™</h1>
            <p>×“"×¨ ××¨×™××œ ×›×¥ - ××•××—×” ×œ×¨×¤×•××ª ××£ ××•×–×Ÿ ×’×¨×•×Ÿ - ×›×™×¨×•×¨×’×™×™×ª ×¨××© ×¦×•×•××¨</p>
        </div>

        <div class="main-content">
            <!-- ×“×£ ×¨××©×™ -->
            <div id="mainSection" class="section active">
                <div class="main-buttons">
                    <button class="main-btn" onclick="showNewConsultation()">
                        ğŸ“ ×”×–× ×ª ×¡×™×›×•× ×™×™×¢×•×¥ ×—×“×©
                    </button>
                    <button class="main-btn secondary" onclick="showHistory()">
                        ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ×¡×™×›×•××™×
                    </button>
                </div>
            </div>

            <!-- ×”×–× ×ª ×¡×™×›×•× ×—×“×© -->
            <div id="newConsultationSection" class="section">
                <button class="btn back" onclick="showMain()">â† ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
                
                <div class="form-container">
                    <h2>×¡×™×›×•× ×™×™×¢×•×¥ ×¨×¤×•××™ ×—×“×©</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName">×©× ×”××˜×•×¤×œ</label>
                            <input type="text" id="patientName" placeholder="×”×–×Ÿ ×©× ××œ×">
                        </div>
                        <div class="form-group">
                            <label for="patientId">×ª×¢×•×“×ª ×–×”×•×ª</label>
                            <input type="text" id="patientId" placeholder="×”×–×Ÿ ××¡×¤×¨ ×ª×¢×•×“×ª ×–×”×•×ª">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="medicalReview">×¡×§×™×¨×” ×¨×¤×•××™×ª</label>
                        <textarea id="medicalReview" placeholder="×”×–×Ÿ ×¡×§×™×¨×” ×¨×¤×•××™×ª ××¤×•×¨×˜×ª..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="diagnosis">××‘×—× ×•×ª</label>
                        <textarea id="diagnosis" placeholder="×”×–×Ÿ ××‘×—× ×•×ª..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="instructions">×”× ×—×™×•×ª</label>
                        <textarea id="instructions" placeholder="×”×–×Ÿ ×”× ×—×™×•×ª ×˜×™×¤×•×œ..."></textarea>
                    </div>
                    <div class="form-group">
    <label for="recipientEmail">×›×ª×•×‘×ª ××™×™×œ ×œ×©×œ×™×—×” (××•×¤×¦×™×•× ×œ×™)</label>
    <input type="email" id="recipientEmail" placeholder="example@gmail.com">
</div>

                    <div style="text-align: center;">
                        <button class="btn" onclick="generatePreview()">×¦×•×¨ ×ª×¦×•×’×” ××§×“×™××”</button>
                        <button class="btn danger" onclick="clearForm()">× ×§×” ×˜×•×¤×¡</button>
                    </div>
                </div>

                <!-- ×ª×¦×•×’×” ××§×“×™××” -->
                <div id="previewContainer" class="preview-container">
                    <div class="medical-form" id="medicalForm">
                        <!-- ×”×ª×•×›×Ÿ ×™×™×•×•×¦×¨ ×“×™× ××™×ª -->
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn success" onclick="saveAndPrint()">ğŸ’¾ ×”×¢×œ×” ×œ×¢× ×Ÿ ×•×”×“×¤×¡</button>
                        <button class="btn success" onclick="sendTextByEmail()">ğŸ“§ ×©×œ×— ×‘××™×™×œ</button>
                        <button id="clearAfterPrintBtn" class="btn danger hidden" onclick="clearForm()">ğŸ§¹ × ×§×” ×˜×•×¤×¡</button>
                    </div>
                </div>
            </div>

            <!-- ×”×™×¡×˜×•×¨×™×™×ª ×¡×™×›×•××™× -->
            <div id="historySection" class="section">
                <button class="btn back" onclick="showMain()">â† ×—×–×¨×” ×œ×“×£ ×”×¨××©×™</button>
                
                <h2>×”×™×¡×˜×•×¨×™×™×ª ×¡×™×›×•××™×</h2>
                
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©× ××˜×•×¤×œ ××• ×ª×¢×•×“×ª ×–×”×•×ª...">
                    <button class="btn" onclick="searchSummaries()">ğŸ” ×—×¤×©</button>
                </div>

                <div class="stats hidden" id="statsSection">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSummaries">0</div>
                        <div class="stat-label">×¡×™×›×•××™×</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="thisMonth">0</div>
                        <div class="stat-label">×”×—×•×“×©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="latestDate">-</div>
                        <div class="stat-label">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</div>
                    </div>
                </div>

                <div id="loadingHistory" class="loading hidden">
                    <div class="spinner"></div>
                    <div>×˜×•×¢×Ÿ ×”×™×¡×˜×•×¨×™×”...</div>
                </div>

                <table id="historyTable" class="history-table hidden">
                    <thead>
                        <tr>
                            <th>×ª××¨×™×š</th>
                            <th>×©× ×”××˜×•×¤×œ</th>
                            <th>×ª×¢×•×“×ª ×–×”×•×ª</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>

                <div class="empty-state hidden" id="emptyState">
                    <h3>ğŸ“­ ××™×Ÿ ×¡×™×›×•××™× ×œ×”×¦×’×”</h3>
                    <p>×¢×“×™×™×Ÿ ×œ× × ×©××¨×• ×¡×™×›×•××™× ×‘××¢×¨×›×ª</p>
                </div>
            </div>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getStorage, ref, uploadString, getDownloadURL, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCe24QH6BXEWtF2zJWcP8WhV8qKj-3l-00",
        authDomain: "gaash-2ea82.firebaseapp.com",
        projectId: "gaash-2ea82",
        storageBucket: "gaash-2ea82.firebasestorage.app",
        messagingSenderId: "1054252503536",
        appId: "1:1054252503536:web:4b7c546bd737de696e4d35"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);

    // Global variables
    let allSummaries = [];
    let currentSummaries = [];
    let sessionTimer;
    let timeLeft = 30 * 60; // 30 ×“×§×•×ª ×‘×©× ×™×•×ª
    let isAuthenticated = false;

    // Authentication system
    const CORRECT_PIN = "1473";
    // ××ª×—×•×œ EmailJS (×”×•×¡×£ ×œ×ª×—×™×œ×ª ×”×¡×§×¨×™×¤×˜)
(function() {
    emailjs.init("1DzFpfJdsgSxjJ-ac"); // ×”×—×œ×£ ×‘××¤×ª×— ×©×œ×š
})();

// ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª PDF ×‘××™×™×œ
// ×”×—×œ×£ ××ª ×”×¤×•× ×§×¦×™×” sendPdfByEmail ×‘×–×•:
window.sendTextByEmail = async function() {
    if (!isAuthenticated) return;
    
    const email = document.getElementById('recipientEmail').value;
    const patientName = document.getElementById('patientName').value;
    const patientId = document.getElementById('patientId').value;
    const medicalReview = document.getElementById('medicalReview').value;
    const diagnosis = document.getElementById('diagnosis').value;
    const instructions = document.getElementById('instructions').value;
    
    if (!email || !patientName) {
        alert('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™×™×œ ×•×©× ××˜×•×¤×œ');
        return;
    }
    
    const sendButton = document.querySelector('button[onclick="sendTextByEmail()"]');
    
    try {
        if (sendButton) {
            sendButton.disabled = true;
            sendButton.textContent = 'ğŸ“§ ×©×•×œ×— ××™×™×œ...';
        }
        
        const templateParams = {
            to_email: email,
            patient_name: patientName,
            patient_id: patientId,
            visit_date: new Date().toLocaleDateString('he-IL'),
            medical_review: medicalReview || '×œ× ×¦×•×™×Ÿ',
            diagnosis: diagnosis || '×œ× ×¦×•×™×Ÿ',
            instructions: instructions || '×œ× ×¦×•×™×Ÿ'
        };
        
        await emailjs.send(
            'service_qly0erg',
            'template_y1lnrfb',
            templateParams
        );
        
        alert('×”××™×™×œ × ×©×œ×— ×‘×”×¦×œ×—×”! âœ…');
        
    } catch (error) {
        console.error('×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ:', error);
        alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×™×œ: ' + error.text);
    }
    
    if (sendButton) {
        sendButton.disabled = false;
        sendButton.textContent = 'ğŸ“§ ×©×œ×— ×‘××™×™×œ';
    }
    
    resetSessionTimer();
};
    window.attemptLogin = function() {
        const pin1 = document.getElementById('pin1').value;
        const pin2 = document.getElementById('pin2').value;
        const pin3 = document.getElementById('pin3').value;
        const pin4 = document.getElementById('pin4').value;
        
        const enteredPin = pin1 + pin2 + pin3 + pin4;
        
        if (enteredPin.length !== 4) {
            showError("× × ×œ×”×–×™×Ÿ 4 ×¡×¤×¨×•×ª");
            return;
        }
        
        if (enteredPin === CORRECT_PIN) {
            // ×”×¦×œ×—×”
            isAuthenticated = true;
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('timerDisplay').classList.remove('hidden');
            startSessionTimer();
            clearPinInputs();
        } else {
            // ×©×’×™××”
            showError("×§×•×“ ×©×’×•×™, × ×¡×” ×©×•×‘");
            shakePinInputs();
            clearPinInputs();
        }
    };

    function showError(message) {
        const errorElement = document.getElementById('errorMessage');
        errorElement.textContent = message;
        errorElement.classList.add('show');
        
        setTimeout(() => {
            errorElement.classList.remove('show');
        }, 3000);
    }

    function shakePinInputs() {
        const inputs = document.querySelectorAll('.pin-digit');
        inputs.forEach(input => {
            input.classList.add('error');
            setTimeout(() => {
                input.classList.remove('error');
            }, 500);
        });
    }

    function clearPinInputs() {
        document.getElementById('pin1').value = '';
        document.getElementById('pin2').value = '';
        document.getElementById('pin3').value = '';
        document.getElementById('pin4').value = '';
        document.getElementById('pin1').focus();
    }

    function lockSystem() {
        isAuthenticated = false;
        document.getElementById('authOverlay').style.display = 'flex';
        document.getElementById('timerDisplay').classList.add('hidden');
        clearTimeout(sessionTimer);
        clearPinInputs();
        
        // ×”×¡×ª×¨ ××ª ×›×œ ×”×¡×¢×™×¤×™× ×•×ª×—×–×•×¨ ×œ×“×£ ×”×¨××©×™
        hideAllSections();
        document.getElementById('mainSection').classList.add('active');
    }

    function startSessionTimer() {
        timeLeft = 30 * 60; // ××™×¤×•×¡ ×œ-30 ×“×§×•×ª
        updateTimerDisplay();
        
        sessionTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 0) {
                lockSystem();
            }
        }, 1000);
    }

    function resetSessionTimer() {
        if (isAuthenticated) {
            clearTimeout(sessionTimer);
            startSessionTimer();
        }
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timeLeft').textContent = display;
        
        const timerElement = document.getElementById('timerDisplay');
        timerElement.classList.remove('warning', 'danger');
        
        if (timeLeft <= 300) { // 5 ×“×§×•×ª ××—×¨×•× ×•×ª
            timerElement.classList.add('danger');
        } else if (timeLeft <= 600) { // 10 ×“×§×•×ª ××—×¨×•× ×•×ª
            timerElement.classList.add('warning');
        }
    }

    // PIN input handling
    document.addEventListener('DOMContentLoaded', function() {
        const pinInputs = document.querySelectorAll('.pin-digit');
        
pinInputs.forEach((input, index) => {
    input.addEventListener('input', function() {
        if (this.value) {
            this.classList.add('filled');
            // ×¢×‘×•×¨ ×œ×ª×™×‘×” ×”×‘××” (××©×××œ ×œ×™××™×Ÿ)
            if (index < pinInputs.length - 1) {
                pinInputs[index + 1].focus();
            } else {
                // ×× ×–×• ×”×ª×™×‘×” ×”××—×¨×•× ×”, × ×¡×” ×œ×”×ª×—×‘×¨ ××•×˜×•××˜×™×ª
                setTimeout(attemptLogin, 100);
            }
        } else {
            this.classList.remove('filled');
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && index > 0) {
            // ×—×–×•×¨ ×œ×ª×™×‘×” ×”×§×•×“××ª (×™××™×Ÿ ×œ×©×××œ ×‘×‘×™×˜×•×œ)
            pinInputs[index - 1].focus();
        }
        if (e.key === 'Enter') {
            attemptLogin();
        }
    });
});

// ×¤×•×§×•×¡ ×¨××©×•× ×™ ×¢×œ ×”×ª×™×‘×” ×”×¨××©×•× ×” (×”×©×××œ×™×ª)
pinInputs[0].focus();
    });

    // Activity tracking - reset timer on any interaction
    document.addEventListener('click', resetSessionTimer);
    document.addEventListener('keypress', resetSessionTimer);
    document.addEventListener('scroll', resetSessionTimer);
    document.addEventListener('mousemove', resetSessionTimer);

    // Navigation functions
    window.showMain = function() {
        if (!isAuthenticated) return;
        hideAllSections();
        document.getElementById('mainSection').classList.add('active');
        resetSessionTimer();
    };

// ×”×—×œ×£ ××ª ×”×¤×•× ×§×¦×™×” showNewConsultation ×‘×–×•:
window.showNewConsultation = function() {
    if (!isAuthenticated) return;
    
    hideAllSections();
    document.getElementById('newConsultationSection').classList.add('active');
    
    // **×ª××™×“ × ×§×” ××ª ×”×˜×•×¤×¡ ×›×©× ×›× ×¡×™× ×œ×¡×™×›×•× ×—×“×©**
    document.getElementById('patientName').value = '';
    document.getElementById('patientId').value = '';
    document.getElementById('medicalReview').value = '';
    document.getElementById('diagnosis').value = '';
    document.getElementById('instructions').value = '';
    document.getElementById('recipientEmail').value = '';
    
    // ×”×¡×ª×¨ ××ª ×”×ª×¦×•×’×” ×”××§×“×™××”
    document.getElementById('previewContainer').classList.remove('active');
    document.getElementById('clearAfterPrintBtn').classList.add('hidden');
    
    resetSessionTimer();
};

    window.showHistory = function() {
        if (!isAuthenticated) return;
        hideAllSections();
        document.getElementById('historySection').classList.add('active');
        loadHistory();
        resetSessionTimer();
    };

    function hideAllSections() {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
    }

    // Form functions
    window.generatePreview = function() {
        if (!isAuthenticated) return;
        
        const patientName = document.getElementById('patientName').value;
        const patientId = document.getElementById('patientId').value;
        const medicalReview = document.getElementById('medicalReview').value;
        const diagnosis = document.getElementById('diagnosis').value;
        const instructions = document.getElementById('instructions').value;

        if (!patientName || !patientId) {
            alert('×™×© ×œ××œ× ×œ×¤×—×•×ª ×©× ××˜×•×¤×œ ×•×ª×¢×•×“×ª ×–×”×•×ª');
            return;
        }

        const today = new Date().toLocaleDateString('he-IL');
        
        const formHtml = `
            <div class="doctor-header">
                <div class="doctor-name">×“"×¨ ××¨×™××œ ×›×¥</div>
                <div class="doctor-title">××•××—×” ×œ×¨×¤×•××ª ××£ ××•×–×Ÿ ×’×¨×•×Ÿ - ×›×™×¨×•×¨×’×™×™×ª ×¨××© ×¦×•×•××¨</div>
                <div class="doctor-license">×.×¨. 38091 ×.×¨.× 30570</div>
                <div class="clinic-info">××¨×¤××ª ××¨×•×, ××× ×•×Ÿ ×•×ª××¨ 6 × ×ª× ×™×”, ×˜×œ×¤×•×Ÿ - 074-705-0889</div>
            </div>

            <div class="visit-info">
                <div class="patient-info">
                    <div class="patient-name">${patientName}</div>
                    <div class="patient-id">×ª"×– ${patientId}</div>
                </div>
                <div class="visit-date">${today}</div>
            </div>

            <div class="summary-title">×¡×™×›×•× ×™×™×¢×•×¥ ×¨×¤×•××™</div>

            <div class="visit-details">
                ×‘×™×§×•×¨ ×©× ×¢×¨×š ×‘× ×ª× ×™×” ×‘×ª××¨×™×š ${today}
            </div>

            <div class="medical-content">
                ${medicalReview ? `<div class="content-section">
                    <div class="section-title">×¡×§×™×¨×”:</div>
                    <div>${medicalReview.replace(/\n/g, '<br>')}</div>
                </div>` : ''}

${diagnosis ? `<div class="content-section">
    <div class="section-title">××‘×—× ×•×ª:</div>
    <div class="diagnosis-content" style="direction: ltr; text-align: left; font-weight: bold;">${diagnosis.replace(/\n/g, '<br>')}</div>
</div>` : ''}
            </div>

            <div class="diagnosis-line"></div>

            <div class="instructions-title">×”× ×—×™×•×ª:</div>
            <div class="medical-content">
                ${instructions ? instructions.replace(/\n/g, '<br>') : ''}
            </div>

<div class="signature-section">
    <div class="signature-text">
        ×‘×‘×¨×›×”,<br>×“"×¨ ××¨×™××œ ×›×¥
    </div>
</div>

<div class="page-break-spacer" style="page-break-before: always; height: 3cm; visibility: hidden; margin: 0; padding: 0;"></div>
        `;

        document.getElementById('medicalForm').innerHTML = formHtml;
        document.getElementById('previewContainer').classList.add('active');
        
        // ×’×œ×™×œ×” ×œ×ª×¦×•×’×” ×”××§×“×™××”
        document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        resetSessionTimer();
    };

    window.clearForm = function() {
        if (!isAuthenticated) return;
        
        document.getElementById('patientName').value = '';
        document.getElementById('patientId').value = '';
        document.getElementById('medicalReview').value = '';
        document.getElementById('diagnosis').value = '';
        document.getElementById('instructions').value = '';
        document.getElementById('previewContainer').classList.remove('active');
        document.getElementById('clearAfterPrintBtn').classList.add('hidden');
        resetSessionTimer();
    };

    // ×©××™×¨×” ×¨×§ ×œ×¢× ×Ÿ
    window.saveAndPrint = async function() {
        if (!isAuthenticated) return;
        
        const patientName = document.getElementById('patientName').value;
        const patientId = document.getElementById('patientId').value;
        const medicalReview = document.getElementById('medicalReview').value;
        const diagnosis = document.getElementById('diagnosis').value;
        const instructions = document.getElementById('instructions').value;

        if (!patientName || !patientId) {
            alert('×™×© ×œ××œ× ×œ×¤×—×•×ª ×©× ××˜×•×¤×œ ×•×ª×¢×•×“×ª ×–×”×•×ª');
            return;
        }

        try {
            // ×™×¦×™×¨×ª ×©× ×§×•×‘×¥ ×¢× ×ª××¨×™×š ×•×©×¢×”
            const now = new Date();
            const dateStr = now.toLocaleDateString('he-IL').replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
            const fileName = `${patientName}_${patientId}_${dateStr}_${timeStr}.json`;

            // ×™×¦×™×¨×ª × ×ª×•× ×™× ×œ×©××™×¨×”
            const summaryData = {
                patientName: patientName,
                patientId: patientId,
                medicalReview: medicalReview,
                diagnosis: diagnosis,
                instructions: instructions,
                date: now.toISOString(),
                dateString: now.toLocaleDateString('he-IL'),
                timeString: now.toLocaleTimeString('he-IL')
            };

            // ×©××™×¨×” ×‘×¢× ×Ÿ ×‘×œ×‘×“
            const storageRef = ref(storage, `ariel/${fileName}`);
            await uploadString(storageRef, JSON.stringify(summaryData), 'raw');

            alert('×”×¡×™×›×•× × ×©××¨ ×‘×¢× ×Ÿ ×‘×”×¦×œ×—×”! âœ…');
            
        } catch (error) {
            console.error('×©×’×™××” ×‘×©××™×¨×”:', error);
            alert('âš ï¸ ×©×’×™××” ×‘×©××™×¨×” ×œ×¢× ×Ÿ. × ×¡×” ×©×•×‘.');
            return;
        }
        
        // ×”×“×¤×¡×”
        const originalTitle = document.title;
        const dateStr = new Date().toLocaleDateString('he-IL').replace(/\//g, '-');
        document.title = `×¡×™×›×•×_${patientName}_${dateStr}`;

        setTimeout(() => {
            window.print();
            
            setTimeout(() => {
                document.title = originalTitle;
                document.getElementById('clearAfterPrintBtn').classList.remove('hidden');
            }, 1000);
        }, 300);
        
        resetSessionTimer();
    };

    // ×˜×¢×™× ×” ×¨×§ ××”×¢× ×Ÿ
// ×”×—×œ×£ ××ª ×”×¤×•× ×§×¦×™×” loadHistory ×‘×–×• (×™×©×™×¨×•×ª ×¢× proxy, ×œ×œ× × ×™×¡×™×•× ×•×ª ××™×•×ª×¨×™×):
async function loadHistory() {
    if (!isAuthenticated) return;
    
    try {
        document.getElementById('loadingHistory').classList.remove('hidden');
        document.getElementById('historyTable').classList.add('hidden');
        document.getElementById('statsSection').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');

        allSummaries = [];

        try {
            const listRef = ref(storage, 'ariel/');
            const result = await listAll(listRef);
            
            console.log(`× ××¦××• ${result.items.length} ×§×‘×¦×™×, ×˜×•×¢×Ÿ ×‘××§×‘×™×œ...`);
            
            // ×˜×¢×™× ×” ×‘××§×‘×™×œ ×©×œ ×›×œ ×”×§×‘×¦×™× - ×™×©×™×¨×•×ª ×¢× proxy
            const loadPromises = result.items.map(async (itemRef) => {
                try {
                    const url = await getDownloadURL(itemRef);
                    
                    // ×©×™××•×© ×™×©×™×¨ ×‘-proxy ××”×™×¨ ×™×•×ª×¨
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const text = await response.text();
                    const data = JSON.parse(text);
                    
                    data.id = itemRef.name;
                    data.isCloud = true;
                    return data;
                    
                } catch (fileError) {
                    console.log(`×§×•×‘×¥ ${itemRef.name} ×œ× × ×˜×¢×Ÿ:`, fileError.message);
                    return null;
                }
            });
            
            // ×××ª×™×Ÿ ×œ×›×œ ×”×˜×¢×™× ×•×ª ×‘××§×‘×™×œ ×¢× timeout
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Timeout')), 15000) // 15 ×©× ×™×•×ª timeout
            );
            
            const results = await Promise.race([
                Promise.allSettled(loadPromises),
                timeoutPromise
            ]);
            
            // ××¡× ×Ÿ ×¨×§ ××ª ×”×ª×•×¦××•×ª ×”××•×¦×œ×—×•×ª
            if (Array.isArray(results)) {
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value) {
                        allSummaries.push(result.value);
                    }
                });
            }
            
            console.log(`âœ… × ×˜×¢× ×• ${allSummaries.length} ×¡×™×›×•××™× ×‘×”×¦×œ×—×”`);
            
        } catch (cloudError) {
            console.error('×©×’×™××” ×‘×˜×¢×™× ×”:', cloudError);
            document.getElementById('loadingHistory').innerHTML = 
                '<div style="color: #e74c3c;">âŒ ×©×’×™××” ×‘×˜×¢×™× ×” ××”×¢× ×Ÿ</div>';
            return;
        }

        // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×”×—×“×© ×‘×™×•×ª×¨ ×§×•×“×)
        allSummaries.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        currentSummaries = allSummaries;
        displayHistory();
        updateStats();

        document.getElementById('loadingHistory').classList.add('hidden');
        
        if (allSummaries.length > 0) {
            document.getElementById('historyTable').classList.remove('hidden');
            document.getElementById('statsSection').classList.remove('hidden');
        } else {
            document.getElementById('emptyState').classList.remove('hidden');
        }

    } catch (error) {
        console.error('×©×’×™××” ×›×œ×œ×™×ª:', error);
        document.getElementById('loadingHistory').innerHTML = 
            '<div style="color: #e74c3c;">âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×”×™×¡×˜×•×¨×™×”</div>';
    }
    
    resetSessionTimer();
}

function displayHistory() {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';

    currentSummaries.forEach((summary) => {
        const row = document.createElement('tr');
        const date = new Date(summary.date).toLocaleDateString('he-IL');
        const time = summary.timeString || new Date(summary.date).toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
        
        row.innerHTML = `
            <td>${date} ${time} â˜ï¸</td>
            <td>${summary.patientName || '×œ× ×–××™×Ÿ'}</td>
            <td>${summary.patientId || '×œ× ×–××™×Ÿ'}</td>
            <td class="actions">
                <button class="btn" onclick="viewSummary('${summary.id}')">ğŸ‘ï¸ ×¦×¤×™×™×”</button>
                <button class="btn success" onclick="printSummary('${summary.id}')">ğŸ–¨ï¸ ×”×“×¤×¡×”</button>
                <button class="btn danger" onclick="deleteSummary('${summary.id}', '${summary.patientName || '××˜×•×¤×œ ×œ× ×™×“×•×¢'}')">ğŸ—‘ï¸ ××—×™×§×”</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (currentSummaries.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="4" style="text-align: center; padding: 30px; color: #666;">××™×Ÿ ×¡×™×›×•××™× ×œ×”×¦×’×”</td>';
        tbody.appendChild(row);
    }
}

    function updateStats() {
        const total = allSummaries.length;
        const thisMonth = allSummaries.filter(s => {
            const summaryDate = new Date(s.date);
            const now = new Date();
            return summaryDate.getMonth() === now.getMonth() && 
                   summaryDate.getFullYear() === now.getFullYear();
        }).length;
        
        const latest = allSummaries.length > 0 ? 
            new Date(allSummaries[0].date).toLocaleDateString('he-IL') : '-';

        document.getElementById('totalSummaries').textContent = total;
        document.getElementById('thisMonth').textContent = thisMonth;
        document.getElementById('latestDate').textContent = latest;
    }

    window.searchSummaries = function() {
        if (!isAuthenticated) return;
        
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        
        if (!searchTerm) {
            currentSummaries = allSummaries;
        } else {
            currentSummaries = allSummaries.filter(summary => 
                (summary.patientName && summary.patientName.toLowerCase().includes(searchTerm)) ||
                (summary.patientId && summary.patientId.includes(searchTerm))
            );
        }
        
        displayHistory();
        
        if (currentSummaries.length > 0) {
            document.getElementById('historyTable').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
        } else {
            document.getElementById('historyTable').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
            document.querySelector('.empty-state h3').textContent = 'ğŸ” ×œ× × ××¦××• ×ª×•×¦××•×ª';
            document.querySelector('.empty-state p').textContent = '× ×¡×” ×œ×—×¤×© ×‘××™×œ×•×ª ××¤×ª×— ××—×¨×•×ª';
        }
        
        resetSessionTimer();
    };

    window.viewSummary = function(summaryId) {
        if (!isAuthenticated) return;
        
        const summary = allSummaries.find(s => s.id === summaryId);
        if (!summary) {
            alert('×¡×™×›×•× ×œ× × ××¦×');
            return;
        }

        // ××™×œ×•×™ ×”×˜×•×¤×¡ ×¢× ×”× ×ª×•× ×™× ×”×§×™×™××™×
        document.getElementById('patientName').value = summary.patientName || '';
        document.getElementById('patientId').value = summary.patientId || '';
        document.getElementById('medicalReview').value = summary.medicalReview || '';
        document.getElementById('diagnosis').value = summary.diagnosis || '';
        document.getElementById('instructions').value = summary.instructions || '';

        // ×¢×‘×•×¨ ×œ×¢××•×“ ×”×—×“×© ×•×¦×•×¨ ×ª×¦×•×’×” ××§×“×™××”
        showNewConsultation();
        setTimeout(() => {
            generatePreview();
            // ×’×œ×™×œ×” ×œ×ª×¦×•×’×” ×”××§×“×™××”
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        }, 100);
        
        resetSessionTimer();
    };

    window.printSummary = function(summaryId) {
        if (!isAuthenticated) return;
        
        const summary = allSummaries.find(s => s.id === summaryId);
        if (!summary) {
            alert('×¡×™×›×•× ×œ× × ××¦×');
            return;
        }

        // ×©××™×¨×ª ×”×¢×¨×›×™× ×”× ×•×›×—×™×™× ×©×œ ×”×˜×•×¤×¡
        const originalValues = {
            name: document.getElementById('patientName').value,
            id: document.getElementById('patientId').value,
            review: document.getElementById('medicalReview').value,
            diagnosis: document.getElementById('diagnosis').value,
            instructions: document.getElementById('instructions').value
        };

        // ××™×œ×•×™ ×”×˜×•×¤×¡ ×¢× × ×ª×•× ×™ ×”×¡×™×›×•× ×”× ×‘×—×¨
        document.getElementById('patientName').value = summary.patientName || '';
        document.getElementById('patientId').value = summary.patientId || '';
        document.getElementById('medicalReview').value = summary.medicalReview || '';
        document.getElementById('diagnosis').value = summary.diagnosis || '';
        document.getElementById('instructions').value = summary.instructions || '';

        // **×¦×¢×“ ×§×¨×™×˜×™**: ××¢×‘×¨ ×œ×¢××•×“ ×”×¡×™×›×•× ×”×—×“×©
        showNewConsultation();
        
        // ×™×¦×™×¨×ª ×”×ª×¦×•×’×” ×”××§×“×™××”
        setTimeout(() => {
            generatePreview();
            
            // ×¦×™×•×Ÿ ×©×”×“×¤×¡×” ××”×™×¡×˜×•×¨×™×” - ×™×© ×œ×”×—×–×™×¨ ××ª ×”×¢×¨×›×™× ××—×¨ ×›×š
            window.printingFromHistory = true;
            window.originalHistoryValues = originalValues;
            
            // ×”×“×¤×¡×”
            setTimeout(() => {
                const originalTitle = document.title;
                document.title = `×¡×™×›×•×_${summary.patientName}_${new Date(summary.date).toLocaleDateString('he-IL').replace(/\//g, '-')}`;
                
                setTimeout(() => {
                    window.print();
                    document.title = originalTitle;
                    
                    // ×—×–×¨×” ×œ×¢××•×“ ×”×”×™×¡×˜×•×¨×™×” ×•×©×—×–×•×¨ ×”×¢×¨×›×™×
                    setTimeout(() => {
                        if (window.printingFromHistory) {
                            showHistory();
                            
                            // ×©×—×–×•×¨ ×”×¢×¨×›×™× ×”××§×•×¨×™×™× ×‘×˜×•×¤×¡
                            document.getElementById('patientName').value = window.originalHistoryValues.name;
                            document.getElementById('patientId').value = window.originalHistoryValues.id;
                            document.getElementById('medicalReview').value = window.originalHistoryValues.review;
                            document.getElementById('diagnosis').value = window.originalHistoryValues.diagnosis;
                            document.getElementById('instructions').value = window.originalHistoryValues.instructions;
                            
                            // × ×™×§×•×™ ××©×ª× ×™ ×”×¢×–×¨
                            window.printingFromHistory = false;
                            window.originalHistoryValues = null;
                        }
                    }, 1000);
                }, 300);
            }, 500);
        }, 200);
        
        resetSessionTimer();
    };

    // Event listeners
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchSummaries();
        }
    });

    // ×˜×¢×™× ×” ××•×˜×•××˜×™×ª ×©×œ ×”×¨×©×™××” ×›×©×”×¢××•×“ × ×˜×¢×Ÿ
    window.addEventListener('load', function() {
        console.log('××¢×¨×›×ª ×¡×™×›×•××™ ×™×™×¢×•×¥ ×¨×¤×•××™ ××•×›× ×” ×œ×©×™××•×©');
    });

    // ×”×•×¡×£ ××ª ×–×” ×œ×§×•×“ ×©×œ×š
// ×”×—×œ×£ ××ª ×›×œ ×”×§×˜×¢ ×©×œ document.addEventListener('DOMContentLoaded' ×‘×–×”:

document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('textarea');
    
    // ×ª×™×§×•×Ÿ ×œ××™×™×¤×•×Ÿ
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
        textareas.forEach(textarea => {
            textarea.addEventListener('focus', function() {
                if (this.id === 'diagnosis') {
                    this.style.textAlign = 'left';
                    this.style.direction = 'ltr';
                } else {
                    this.style.textAlign = 'right';
                    this.style.direction = 'rtl';
                }
            });
        });
    }
    
    textareas.forEach(textarea => {
        // ×˜×™×¤×•×œ ××™×•×—×“ ×‘××§×© Enter ×‘××‘×—× ×•×ª - ×¨×§ Enter!
        if (textarea.id === 'diagnosis') {
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const cursorPos = this.selectionStart;
                    const textBefore = this.value.substring(0, cursorPos);
                    const textAfter = this.value.substring(cursorPos);
                    
                    // ×”×•×¡×£ ×©×•×¨×” ×—×“×©×” ×¢× × ×§×•×“×”
                    this.value = textBefore + '\nâ€¢ ' + textAfter;
                    
                    // ×”×¢×‘×¨ ××ª ×”×¡××Ÿ ×œ××§×•× ×”× ×›×•×Ÿ (××—×¨×™ ×”× ×§×•×“×” ×•×”×¨×•×•×—)
                    this.selectionStart = this.selectionEnd = cursorPos + 3;
                }
                // ×›×œ ×”××§×©×™× ×”××—×¨×™× (×›×•×œ×œ ×¨×•×•×—, ××•×ª×™×•×ª, ××¡×¤×¨×™×) ×¢×•×‘×¨×™× ×¨×’×™×œ!
            });
            
            // ×•×•×“× ×©×”×©×•×¨×” ×”×¨××©×•× ×” ××ª×—×™×œ×” ×‘× ×§×•×“×” ×›×©××ª×—×™×œ×™× ×œ×”×§×œ×™×“
            textarea.addEventListener('input', function(e) {
                if (this.value && !this.value.startsWith('â€¢ ') && !this.value.includes('\n')) {
                    // ×¨×§ ×× ×–×• ×”×©×•×¨×” ×”×¨××©×•× ×” ×•×—×¡×¨×” × ×§×•×“×”
                    const cursorPos = this.selectionStart;
                    this.value = 'â€¢ ' + this.value;
                    this.selectionStart = this.selectionEnd = cursorPos + 2;
                }
            });
        }
        
        // ×œ×©××¨ ×”×©×“×•×ª - ×œ×œ× ×©×™× ×•×™
        else {
            textarea.addEventListener('input', function(e) {
                // ×›××Ÿ ×™×›×•×œ ×œ×”×™×•×ª ×§×•×“ ×œ×¢×™×‘×•×“ ×©×“×•×ª ××—×¨×™× ×× ×¦×¨×™×š
            });
        }
    });
});
window.deleteSummary = async function(summaryId, patientName) {
    if (!isAuthenticated) return;
    
    // ××™×©×•×¨ ××—×™×§×”
    const confirmMessage = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×™×›×•× ×©×œ:\n${patientName}?\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`;
    
    if (!confirm(confirmMessage)) {
        return; // ×”××©×ª××© ×‘×™×˜×œ
    }
    
    try {
        // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
        const deleteButtons = document.querySelectorAll(`button[onclick*="${summaryId}"][onclick*="deleteSummary"]`);
        deleteButtons.forEach(btn => {
            btn.disabled = true;
            btn.textContent = 'â³ ××•×—×§...';
        });
        
        // ××—×™×§×” ××”×¢× ×Ÿ
        const fileRef = ref(storage, `ariel/${summaryId}`);
        await deleteObject(fileRef);
        
        // ×”×¡×¨×” ××”××¢×¨×š ×”××§×•××™
        allSummaries = allSummaries.filter(summary => summary.id !== summaryId);
        currentSummaries = currentSummaries.filter(summary => summary.id !== summaryId);
        
        // ×¨×¢× ×•×Ÿ ×”×ª×¦×•×’×”
        displayHistory();
        updateStats();
        
        // ×‘×“×™×§×” ×× × ×©××¨×• ×¡×™×›×•××™×
        if (allSummaries.length === 0) {
            document.getElementById('historyTable').classList.add('hidden');
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }
        
        alert(`âœ… ×”×¡×™×›×•× ×©×œ ${patientName} × ××—×§ ×‘×”×¦×œ×—×”`);
        
    } catch (error) {
        console.error('×©×’×™××” ×‘××—×™×§×ª ×”×¡×™×›×•×:', error);
        alert('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×¡×™×›×•×. × ×¡×” ×©×•×‘.');
        
        // ×”×—×–×¨×ª ×”×›×¤×ª×•×¨×™× ×œ××¦×‘ ×¨×’×™×œ
        const deleteButtons = document.querySelectorAll(`button[onclick*="${summaryId}"][onclick*="deleteSummary"]`);
        deleteButtons.forEach(btn => {
            btn.disabled = false;
            btn.textContent = 'ğŸ—‘ï¸ ××—×™×§×”';
        });
    }
    
    resetSessionTimer();
};
</script>
</body>
</html>
